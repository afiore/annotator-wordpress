(function(){var $,Annotator,Delegator,Range,createDateFromISO8601,fn,functions,util,_Annotator,_i,_j,_len,_len2,_ref;var __slice=Array.prototype.slice,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=Array.prototype.indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(this[i]===item){return i}}return -1};if(!(typeof jQuery!="undefined"&&jQuery!==null?(_ref=jQuery.fn)!=null?_ref.jquery:void 0:void 0)){console.error("Annotator requires jQuery: have you included lib/vendor/jquery.js?")}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")}$=jQuery.sub();$.flatten=function(array){var flatten;flatten=function(ary){var el,flat,_i,_len;flat=[];for(_i=0,_len=ary.length;_i<_len;_i++){el=ary[_i];flat=flat.concat(el&&$.isArray(el)?flatten(el):el)}return flat};return flatten(array)};$.plugin=function(name,object){return jQuery.fn[name]=function(options){var args;args=Array.prototype.slice.call(arguments,1);return this.each(function(){var instance;instance=$.data(this,name);if(instance){return options&&instance[options].apply(instance,args)}else{instance=new object(this,options);return $.data(this,name,instance)}})}};$.fn.textNodes=function(){var getTextNodes;getTextNodes=function(node){var n,_i,_len,_ref,_results;if(node&&node.nodeType!==3){_ref=$(node).contents().get();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){n=_ref[_i];_results.push(getTextNodes(n))}return _results}else{return node}};return this.map(function(){return $.flatten(getTextNodes(this))})};$.fn.xpath=function(relativeRoot){var jq;jq=this.map(function(){var elem,idx,path;path="";elem=this;while(elem&&elem.nodeType===1&&elem!==relativeRoot){idx=$(elem.parentNode).children(elem.tagName).index(elem)+1;idx=idx>1?"["+idx+"]":"";path="/"+elem.tagName.toLowerCase()+idx+path;elem=elem.parentNode}return path});return jq.get()};$.escape=function(html){return html.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};$.fn.escape=function(html){if(arguments.length){return this.html($.escape(html))}return this.html()};functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!="undefined"&&console!==null){if(!(console.group!=null)){console.group=function(name){return console.log("GROUP: ",name)}}if(!(console.groupCollapsed!=null)){console.groupCollapsed=console.group}for(_i=0,_len=functions.length;_i<_len;_i++){fn=functions[_i];if(!(console[fn]!=null)){console[fn]=function(){return console.log("Not implemented: console."+name)}}}}else{this.console={};for(_j=0,_len2=functions.length;_j<_len2;_j++){fn=functions[_j];this.console[fn]=function(){}}this.console.error=function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];return alert("ERROR: "+(args.join(", ")))};this.console.warn=function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];return alert("WARNING: "+(args.join(", ")))}}Delegator=(function(){Delegator.prototype.events={};Delegator.prototype.options={};Delegator.prototype.element=null;function Delegator(element,options){this.options=$.extend(true,{},this.options,options);this.element=$(element);this.on=this.subscribe;this.addEvents()}Delegator.prototype.addEvents=function(){var event,functionName,sel,selector,_i,_ref,_ref2,_results;_ref=this.events;_results=[];for(sel in _ref){functionName=_ref[sel];_ref2=sel.split(" "),selector=2<=_ref2.length?__slice.call(_ref2,0,_i=_ref2.length-1):(_i=0,[]),event=_ref2[_i++];_results.push(this.addEvent(selector.join(" "),event,functionName))}return _results};Delegator.prototype.addEvent=function(bindTo,event,functionName){var closure,isBlankSelector;closure=__bind(function(){return this[functionName].apply(this,arguments)},this);isBlankSelector=typeof bindTo==="string"&&bindTo.replace(/\s+/g,"")==="";if(isBlankSelector){bindTo=this.element}if(typeof bindTo==="string"){this.element.delegate(bindTo,event,closure)}else{if(this.isCustomEvent(event)){this.subscribe(event,closure)}else{$(bindTo).bind(event,closure)}}return this};Delegator.prototype.isCustomEvent=function(event){var natives;natives="blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/);event=event.split(".")[0];return $.inArray(event,natives)===-1};Delegator.prototype.publish=function(){this.element.trigger.apply(this.element,arguments);return this};Delegator.prototype.subscribe=function(event,callback){var closure;closure=function(){return callback.apply(this,[].slice.call(arguments,1))};closure.guid=callback.guid=($.guid+=1);this.element.bind(event,closure);return this};Delegator.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return Delegator})();Range={};Range.sniff=function(r){if(r.commonAncestorContainer!=null){return new Range.BrowserRange(r)}else{if(typeof r.start==="string"){return new Range.SerializedRange(r)}else{if(r.start&&typeof r.start==="object"){return new Range.NormalizedRange(r)}else{console.error("Couldn't not sniff range type");return false}}}};Range.BrowserRange=(function(){function BrowserRange(obj){this.commonAncestorContainer=obj.commonAncestorContainer;this.startContainer=obj.startContainer;this.startOffset=obj.startOffset;this.endContainer=obj.endContainer;this.endOffset=obj.endOffset}BrowserRange.prototype.normalize=function(root){var it,node,nr,offset,p,r,_i,_len,_ref;if(this.tainted){console.error("You may only call normalize() once on a BrowserRange!");return false}else{this.tainted=true}r={};nr={};_ref=["start","end"];for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];node=this[p+"Container"];offset=this[p+"Offset"];if(node.nodeType===1){it=node.childNodes[offset];node=it||node.childNodes[offset-1];while(node.nodeType!==3){node=node.firstChild}offset=it?0:node.nodeValue.length}r[p]=node;r[p+"Offset"]=offset}nr.start=r.startOffset>0?r.start.splitText(r.startOffset):r.start;if(r.start===r.end){if((r.endOffset-r.startOffset)<nr.start.nodeValue.length){nr.start.splitText(r.endOffset-r.startOffset)}nr.end=nr.start}else{if(r.endOffset<r.end.nodeValue.length){r.end.splitText(r.endOffset)}nr.end=r.end}nr.commonAncestor=this.commonAncestorContainer;while(nr.commonAncestor.nodeType!==1){nr.commonAncestor=nr.commonAncestor.parentNode}return new Range.NormalizedRange(nr)};BrowserRange.prototype.serialize=function(root,ignoreSelector){return this.normalize(root).serialize(root,ignoreSelector)};return BrowserRange})();Range.NormalizedRange=(function(){function NormalizedRange(obj){this.commonAncestor=obj.commonAncestor;this.start=obj.start;this.end=obj.end}NormalizedRange.prototype.normalize=function(root){return this};NormalizedRange.prototype.limit=function(bounds){var nodes,parent,startParents,_i,_len,_ref;nodes=$.grep(this.textNodes(),function(node){return node.parentNode===bounds||$.contains(bounds,node.parentNode)});if(!nodes.length){return null}this.start=nodes[0];this.end=nodes[nodes.length-1];startParents=$(this.start).parents();_ref=$(this.end).parents();for(_i=0,_len=_ref.length;_i<_len;_i++){parent=_ref[_i];if(startParents.index(parent)!==-1){this.commonAncestor=parent;break}}return this};NormalizedRange.prototype.serialize=function(root,ignoreSelector){var end,serialization,start;serialization=function(node,isEnd){var n,nodes,offset,origParent,textNodes,xpath,_i,_len;if(ignoreSelector){origParent=$(node).parents(":not("+ignoreSelector+")").eq(0)}else{origParent=$(node).parent()}xpath=origParent.xpath(root)[0];textNodes=origParent.textNodes();nodes=textNodes.slice(0,textNodes.index(node));offset=0;for(_i=0,_len=nodes.length;_i<_len;_i++){n=nodes[_i];offset+=n.nodeValue.length}if(isEnd){return[xpath,offset+node.nodeValue.length]}else{return[xpath,offset]}};start=serialization(this.start);end=serialization(this.end,true);return new Range.SerializedRange({start:start[0],end:end[0],startOffset:start[1],endOffset:end[1]})};NormalizedRange.prototype.text=function(){var node;return((function(){var _i,_len,_ref,_results;_ref=this.textNodes();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];_results.push(node.nodeValue)}return _results}).call(this)).join("")};NormalizedRange.prototype.textNodes=function(){var end,start,textNodes,_ref;textNodes=$(this.commonAncestor).textNodes();_ref=[textNodes.index(this.start),textNodes.index(this.end)],start=_ref[0],end=_ref[1];return $.makeArray(textNodes.slice(start,(end+1)||9000000000))};return NormalizedRange})();Range.SerializedRange=(function(){function SerializedRange(obj){this.start=obj.start;this.startOffset=obj.startOffset;this.end=obj.end;this.endOffset=obj.endOffset}SerializedRange.prototype.normalize=function(root){var cacXPath,common,endAncestry,i,length,nodeFromXPath,p,parentXPath,range,startAncestry,tn,_i,_j,_len,_len2,_ref,_ref2,_ref3;nodeFromXPath=function(xpath){return document.evaluate(xpath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};parentXPath=$(root).xpath()[0];startAncestry=this.start.split("/");endAncestry=this.end.split("/");common=[];range={};for(i=0,_ref=startAncestry.length;(0<=_ref?i<_ref:i>_ref);(0<=_ref?i+=1:i-=1)){if(startAncestry[i]===endAncestry[i]){common.push(startAncestry[i])}else{break}}cacXPath=parentXPath+common.join("/");range.commonAncestorContainer=nodeFromXPath(cacXPath);if(!range.commonAncestorContainer){console.error("Error deserializing range: can't find XPath '"+cacXPath+"'. Is this the right document?");return null}_ref2=["start","end"];for(_i=0,_len=_ref2.length;_i<_len;_i++){p=_ref2[_i];length=0;_ref3=$(nodeFromXPath(parentXPath+this[p])).textNodes();for(_j=0,_len2=_ref3.length;_j<_len2;_j++){tn=_ref3[_j];if(length+tn.nodeValue.length>=this[p+"Offset"]){range[p+"Container"]=tn;range[p+"Offset"]=this[p+"Offset"]-length;break}else{length+=tn.nodeValue.length}}}return new Range.BrowserRange(range).normalize(root)};SerializedRange.prototype.serialize=function(root,ignoreSelector){return this.normalize(root).serialize(root,ignoreSelector)};SerializedRange.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return SerializedRange})();util={getGlobal:function(){return(function(){return this})()},mousePosition:function(e,offsetEl){var offset;offset=$(offsetEl).offset();return{top:e.pageY-offset.top,left:e.pageX-offset.left}}};_Annotator=this.Annotator;Annotator=(function(){__extends(Annotator,Delegator);Annotator.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};Annotator.prototype.html={hl:'<span class="annotator-hl"></span>',adder:'<div class="annotator-adder"><button>Annotate</button></div>',wrapper:'<div class="annotator-wrapper"></div>'};Annotator.prototype.options={};Annotator.prototype.plugins={};Annotator.prototype.editor=null;Annotator.prototype.viewer=null;Annotator.prototype.selectedRanges=null;Annotator.prototype.mouseIsDown=false;Annotator.prototype.ignoreMouseup=false;Annotator.prototype.viewerHideTimer=null;function Annotator(element,options){this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this);this.onEditAnnotation=__bind(this.onEditAnnotation,this);this.onAdderClick=__bind(this.onAdderClick,this);this.onAdderMousedown=__bind(this.onAdderMousedown,this);this.onHighlightMouseover=__bind(this.onHighlightMouseover,this);this.checkForEndSelection=__bind(this.checkForEndSelection,this);this.checkForStartSelection=__bind(this.checkForStartSelection,this);this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this);this.startViewerHideTimer=__bind(this.startViewerHideTimer,this);this.showViewer=__bind(this.showViewer,this);this.onEditorSubmit=__bind(this.onEditorSubmit,this);this.onEditorHide=__bind(this.onEditorHide,this);this.showEditor=__bind(this.showEditor,this);var name,src,_ref;Annotator.__super__.constructor.apply(this,arguments);this.plugins={};if(!Annotator.supported()){return this}this._setupDocumentEvents()._setupWrapper()._setupViewer()._setupEditor();_ref=this.html;for(name in _ref){src=_ref[name];if(name!=="wrapper"){this[name]=$(src).appendTo(this.wrapper).hide()}}}Annotator.prototype._setupWrapper=function(){this.wrapper=$(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};Annotator.prototype._setupViewer=function(){this.viewer=new Annotator.Viewer();this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:__bind(function(field,annotation){$(field).escape(annotation.text||"");return this.publish("annotationViewerTextField",[field,annotation])},this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};Annotator.prototype._setupEditor=function(){this.editor=new Annotator.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:"Comments\u2026",load:function(field,annotation){return $(field).find("textarea").val(annotation.text||"")},submit:function(field,annotation){return annotation.text=$(field).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};Annotator.prototype._setupDocumentEvents=function(){$(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};Annotator.prototype.getSelectedRanges=function(){var browserRange,i,ranges,selection;selection=util.getGlobal().getSelection();ranges=[];if(!selection.isCollapsed){ranges=(function(){var _ref,_results;_results=[];for(i=0,_ref=selection.rangeCount;(0<=_ref?i<_ref:i>_ref);(0<=_ref?i+=1:i-=1)){browserRange=new Range.BrowserRange(selection.getRangeAt(i));_results.push(browserRange.normalize().limit(this.wrapper[0]))}return _results}).call(this)}return $.grep(ranges,function(range){return range})};Annotator.prototype.createAnnotation=function(){var annotation;annotation={};this.publish("beforeAnnotationCreated",[annotation]);return annotation};Annotator.prototype.setupAnnotation=function(annotation,fireEvents){var normed,normedRanges,r,sniffed,_i,_len;if(fireEvents==null){fireEvents=true}annotation.ranges||(annotation.ranges=this.selectedRanges);normedRanges=(function(){var _i,_len,_ref,_results;_ref=annotation.ranges;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){r=_ref[_i];sniffed=Range.sniff(r);_results.push(sniffed.normalize(this.wrapper[0]))}return _results}).call(this);normedRanges=$.grep(normedRanges,function(range){return range!==null});annotation.quote=[];annotation.ranges=[];annotation.highlights=[];for(_i=0,_len=normedRanges.length;_i<_len;_i++){normed=normedRanges[_i];annotation.quote.push($.trim(normed.text()));annotation.ranges.push(normed.serialize(this.wrapper[0],".annotator-hl"));$.merge(annotation.highlights,this.highlightRange(normed))}annotation.quote=annotation.quote.join(" / ");$(annotation.highlights).data("annotation",annotation);if(fireEvents){this.publish("annotationCreated",[annotation])}return annotation};Annotator.prototype.updateAnnotation=function(annotation){this.publish("beforeAnnotationUpdated",[annotation]);this.publish("annotationUpdated",[annotation]);return annotation};Annotator.prototype.deleteAnnotation=function(annotation){var h,_i,_len,_ref;_ref=annotation.highlights;for(_i=0,_len=_ref.length;_i<_len;_i++){h=_ref[_i];$(h).replaceWith(h.childNodes)}this.publish("annotationDeleted",[annotation]);return annotation};Annotator.prototype.loadAnnotations=function(annotations){var clone,loader;if(annotations==null){annotations=[]}loader=__bind(function(annList){var n,now,_i,_len;if(annList==null){annList=[]}now=annList.splice(0,10);for(_i=0,_len=now.length;_i<_len;_i++){n=now[_i];this.setupAnnotation(n,false)}if(annList.length>0){return setTimeout((function(){return loader(annList)}),100)}else{return this.publish("annotationsLoaded",[clone])}},this);clone=annotations.slice();if(annotations.length){loader(annotations)}return this};Annotator.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{return console.warn("Can't dump annotations without Store plugin.")}};Annotator.prototype.highlightRange=function(normedRange){var elemList,node,wrapper;return elemList=(function(){var _i,_len,_ref,_results;_ref=normedRange.textNodes();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];wrapper=this.hl.clone().show();_results.push($(node).wrap(wrapper).parent().get(0))}return _results}).call(this)};Annotator.prototype.addPlugin=function(name,options){var klass,_base;if(this.plugins[name]){console.error("You cannot have more than one instance of any plugin.")}else{klass=Annotator.Plugin[name];if(typeof klass==="function"){this.plugins[name]=new klass(this.element[0],options);this.plugins[name].annotator=this;if(typeof(_base=this.plugins[name]).pluginInit=="function"){_base.pluginInit()}}else{console.error("Could not load "+name+" plugin. Have you included the appropriate <script> tag?")}}return this};Annotator.prototype.showEditor=function(annotation,location){this.editor.element.css(location);this.editor.load(annotation);return this};Annotator.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};Annotator.prototype.onEditorSubmit=function(annotation){this.publish("annotationEditorSubmit",[this.editor,annotation]);if(annotation.ranges===void 0){return this.setupAnnotation(annotation)}else{return this.updateAnnotation(annotation)}};Annotator.prototype.showViewer=function(annotations,location){this.viewer.element.css(location);this.viewer.load(annotations);return this.publish("annotationViewerShown",[this.viewer,annotations])};Annotator.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout((function(ann){return ann.viewer.hide()}),250,this)}};Annotator.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};Annotator.prototype.checkForStartSelection=function(event){if(!(event&&this.isAnnotator(event.target))){this.startViewerHideTimer();return this.mouseIsDown=true}};Annotator.prototype.checkForEndSelection=function(event){var container,range,_i,_len,_ref;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();_ref=this.selectedRanges;for(_i=0,_len=_ref.length;_i<_len;_i++){range=_ref[_i];container=range.commonAncestor;if(this.isAnnotator(container)){return}}if(event&&this.selectedRanges.length){return this.adder.css(util.mousePosition(event,this.wrapper[0])).show()}else{return this.adder.hide()}};Annotator.prototype.isAnnotator=function(element){return !!$(element).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length};Annotator.prototype.onHighlightMouseover=function(event){var annotations;this.clearViewerHideTimer();if(this.mouseIsDown||this.viewer.isShown()){return false}annotations=$(event.target).parents(".annotator-hl").andSelf().map(function(){return $(this).data("annotation")});return this.showViewer($.makeArray(annotations),util.mousePosition(event,this.wrapper[0]))};Annotator.prototype.onAdderMousedown=function(event){if(event!=null){event.preventDefault()}return this.ignoreMouseup=true};Annotator.prototype.onAdderClick=function(event){var position;if(event!=null){event.preventDefault()}position=this.adder.position();this.adder.hide();return this.showEditor(this.createAnnotation(),position)};Annotator.prototype.onEditAnnotation=function(annotation){var offset;offset=this.viewer.element.position();this.viewer.hide();return this.showEditor(annotation,offset)};Annotator.prototype.onDeleteAnnotation=function(annotation){this.viewer.hide();return this.deleteAnnotation(annotation)};return Annotator})();Annotator.Plugin=(function(){__extends(Plugin,Delegator);function Plugin(element,options){Plugin.__super__.constructor.apply(this,arguments)}Plugin.prototype.pluginInit=function(){};return Plugin})();Annotator.$=$;Annotator.supported=function(){return(function(){return !!this.getSelection})()};Annotator.noConflict=function(){util.getGlobal().Annotator=_Annotator;return this};$.plugin("annotator",Annotator);this.Annotator=Annotator;Annotator.Widget=(function(){__extends(Widget,Delegator);Widget.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function Widget(element,options){Widget.__super__.constructor.apply(this,arguments);this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}Widget.prototype.checkOrientation=function(){var current,offset,viewport,widget,window;this.resetOrientation();window=$(util.getGlobal());widget=this.element.children(":first");offset=widget.offset();viewport={top:window.scrollTop(),right:window.width()+window.scrollLeft()};current={top:offset.top,right:offset.left+widget.width()};if((current.top-viewport.top)<0){this.invertY()}if((current.right-viewport.right)>0){this.invertX()}return this};Widget.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};Widget.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};Widget.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};return Widget})();Annotator.Editor=(function(){__extends(Editor,Annotator.Widget);Editor.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};Editor.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};Editor.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">Cancel</a>\n      <a href="#save" class="annotator-save annotator-focus">Save</a>\n    </div>\n    <span class="annotator-resize"></span>\n  </form>\n<div>';Editor.prototype.options={};function Editor(options){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this);this.processKeypress=__bind(this.processKeypress,this);this.submit=__bind(this.submit,this);this.load=__bind(this.load,this);this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);Editor.__super__.constructor.call(this,$(this.html)[0],options);this.fields=[];this.annotation={};this.setupDragabbles()}Editor.prototype.show=function(event){if(event!=null){event.preventDefault()}this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.element.find(":input:first").focus();return this.checkOrientation().publish("show")};Editor.prototype.hide=function(event){if(event!=null){event.preventDefault()}this.element.addClass(this.classes.hide);return this.publish("hide")};Editor.prototype.load=function(annotation){var field,_i,_len,_ref;this.annotation=annotation;this.publish("load",[this.annotation]);_ref=this.fields;for(_i=0,_len=_ref.length;_i<_len;_i++){field=_ref[_i];field.load(field.element,this.annotation)}return this.show()};Editor.prototype.submit=function(event){var field,_i,_len,_ref;if(event!=null){event.preventDefault()}_ref=this.fields;for(_i=0,_len=_ref.length;_i<_len;_i++){field=_ref[_i];field.submit(field.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};Editor.prototype.addField=function(options){var element,field,input;field=$.extend({id:"annotator-field-"+(new Date()).getTime(),type:"input",label:"",load:function(){},submit:function(){}},options);input=null;element=$('<li class="annotator-item" />');field.element=element[0];switch(field.type){case"textarea":input=$("<textarea />");break;case"input":case"checkbox":input=$("<input />")}element.append(input);input.attr({id:field.id,placeholder:field.label});if(field.type==="checkbox"){input[0].type="checkbox";element.addClass("annotator-checkbox");element.append($("<label />",{"for":field.id,html:field.label}))}this.element.find("ul:first").append(element);this.fields.push(field);return field.element};Editor.prototype.checkOrientation=function(){var controls,flipFields,list;Editor.__super__.checkOrientation.apply(this,arguments);list=this.element.find("ul");controls=this.element.find(".annotator-controls");flipFields=function(){return list.children().each(function(){return $(this).parent().prepend(this)})};if(this.element.hasClass(this.classes.invert.y)&&list.is(":first-child")){controls.insertBefore(list);flipFields()}else{if(controls.is(":first-child")){controls.insertAfter(list);flipFields()}}return this};Editor.prototype.processKeypress=function(event){if(event.keyCode===27){return this.hide()}else{if(event.keyCode===13&&!event.shiftKey){return this.submit()}}};Editor.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};Editor.prototype.setupDragabbles=function(){var classes,controls,editor,mousedown,onMousedown,onMousemove,onMouseup,resize,textarea,throttle;mousedown=null;classes=this.classes;editor=this.element;textarea=null;resize=editor.find(".annotator-resize");controls=editor.find(".annotator-controls");throttle=false;onMousedown=function(event){if(event.target===this){mousedown={element:this,top:event.pageY,left:event.pageX};textarea=editor.find("textarea:first");$(window).bind({"mouseup.annotator-editor-resize":onMouseup,"mousemove.annotator-editor-resize":onMousemove});return event.preventDefault()}};onMouseup=function(){mousedown=null;return $(window).unbind(".annotator-editor-resize")};onMousemove=__bind(function(event){var diff,directionX,directionY,height,width;if(mousedown&&throttle===false){diff={top:event.pageY-mousedown.top,left:event.pageX-mousedown.left};if(mousedown.element===resize[0]){height=textarea.outerHeight();width=textarea.outerWidth();directionX=editor.hasClass(classes.invert.x)?-1:1;directionY=editor.hasClass(classes.invert.y)?1:-1;textarea.height(height+(diff.top*directionY));textarea.width(width+(diff.left*directionX));if(textarea.outerHeight()!==height){mousedown.top=event.pageY}if(textarea.outerWidth()!==width){mousedown.left=event.pageX}}else{if(mousedown.element===controls[0]){editor.css({top:parseInt(editor.css("top"),10)+diff.top,left:parseInt(editor.css("left"),10)+diff.left});mousedown.top=event.pageY;mousedown.left=event.pageX}}throttle=true;return setTimeout(function(){return throttle=false},1000/60)}},this);resize.bind("mousedown",onMousedown);return controls.bind("mousedown",onMousedown)};return Editor})();Annotator.Viewer=(function(){__extends(Viewer,Annotator.Widget);Viewer.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};Viewer.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};Viewer.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button class="annotator-edit">Edit</button>\n    <button class="annotator-delete">Delete</button>\n  </span>\n</li>'};function Viewer(options){this.onDeleteClick=__bind(this.onDeleteClick,this);this.onEditClick=__bind(this.onEditClick,this);this.load=__bind(this.load,this);this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);Viewer.__super__.constructor.call(this,$(this.html.element)[0],options);this.item=$(this.html.item)[0];this.fields=[];this.annotations=[]}Viewer.prototype.show=function(event){var controls;if(event!=null){event.preventDefault()}controls=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((__bind(function(){return controls.removeClass(this.classes.showControls)},this)),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};Viewer.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};Viewer.prototype.hide=function(event){if(event!=null){event.preventDefault()}this.element.addClass(this.classes.hide);return this.publish("hide")};Viewer.prototype.load=function(annotations){var annotation,controller,controls,del,edit,element,field,item,list,_i,_j,_len,_len2,_ref,_ref2;this.annotations=annotations||[];list=this.element.find("ul:first").empty();_ref=this.annotations;for(_i=0,_len=_ref.length;_i<_len;_i++){annotation=_ref[_i];item=$(this.item).clone().appendTo(list).data("annotation",annotation);controls=item.find(".annotator-controls");edit=controls.find(".annotator-edit");del=controls.find(".annotator-delete");controller={showEdit:function(){return edit.removeAttr("disabled")},hideEdit:function(){return edit.attr("disabled","disabled")},showDelete:function(){return del.removeAttr("disabled")},hideDelete:function(){return del.attr("disabled","disabled")}};_ref2=this.fields;for(_j=0,_len2=_ref2.length;_j<_len2;_j++){field=_ref2[_j];element=$(field.element).clone().appendTo(item)[0];field.load(element,annotation,controller)}}this.publish("load",[this.annotations]);return this.show()};Viewer.prototype.addField=function(options){var field;field=$.extend({load:function(){}},options);field.element=$("<div />")[0];this.fields.push(field);field.element;return this};Viewer.prototype.onEditClick=function(event){return this.onButtonClick(event,"edit")};Viewer.prototype.onDeleteClick=function(event){return this.onButtonClick(event,"delete")};Viewer.prototype.onButtonClick=function(event,type){var item;item=$(event.target).parents(".annotator-annotation");return this.publish(type,[item.data("annotation")])};return Viewer})();Annotator=Annotator||{};Annotator.Notification=(function(){__extends(Notification,Delegator);Notification.prototype.events={click:"hide"};Notification.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function Notification(options){this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);Notification.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],options)}Notification.prototype.show=function(message,status){if(status==null){status=Annotator.Notification.INFO}$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[status]).escape(message||"");setTimeout(this.hide,5000);return this};Notification.prototype.hide=function(){$(this.element).removeClass(this.options.classes.show);return this};return Notification})();Annotator.Notification.INFO="show";Annotator.Notification.SUCCESS="success";Annotator.Notification.ERROR="error";$(function(){var notification;notification=new Annotator.Notification;Annotator.showNotification=notification.show;return Annotator.hideNotification=notification.hide});Annotator.Plugin.Tags=(function(){function Tags(){this.setAnnotationTags=__bind(this.setAnnotationTags,this);this.updateField=__bind(this.updateField,this);Tags.__super__.constructor.apply(this,arguments)}__extends(Tags,Annotator.Plugin);Tags.prototype.field=null;Tags.prototype.input=null;Tags.prototype.pluginInit=function(){if(!Annotator.supported()){return}this.field=this.annotator.editor.addField({label:"Add some tags here\u2026",load:this.updateField,submit:this.setAnnotationTags});this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){this.annotator.plugins.Filter.addFilter({label:"Tag",property:"tags",isFiltered:function(input,tags){var keyword,keywords,matched,tag,_i,_j,_len,_len2;if(input&&(tags!=null?tags.length:void 0)){matched=0;keywords=input.split(/\s+/g);for(_i=0,_len=keywords.length;_i<_len;_i++){keyword=keywords[_i];for(_j=0,_len2=tags.length;_j<_len2;_j++){tag=tags[_j];if(tag.indexOf(keyword)!==-1){matched+=1}}}}return matched===keywords.length}})}return this.input=$(this.field).find(":input")};Tags.prototype.parseTags=function(string){var tags;string=$.trim(string);tags=[];if(string){tags=string.split(/\s+/)}return tags};Tags.prototype.stringifyTags=function(array){return array.join(" ")};Tags.prototype.updateField=function(field,annotation){var value;value="";if(annotation.tags){value=this.stringifyTags(annotation.tags)}return this.input.val(value)};Tags.prototype.setAnnotationTags=function(field,annotation){return annotation.tags=this.parseTags(this.input.val())};Tags.prototype.updateViewer=function(field,annotation){field=$(field);if(annotation.tags&&$.isArray(annotation.tags)&&annotation.tags.length){return field.addClass("annotator-tags").html(function(){var string;return string=$.map(annotation.tags,function(tag){return'<span class="annotator-tag">'+Annotator.$.escape(tag)+"</span>"}).join(" ")})}else{return field.remove()}};return Tags})();createDateFromISO8601=function(string){var d,date,offset,regexp,time,_ref;regexp="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";d=string.match(new RegExp(regexp));offset=0;date=new Date(d[1],0,1);if(d[3]){date.setMonth(d[3]-1)}if(d[5]){date.setDate(d[5])}if(d[7]){date.setHours(d[7])}if(d[8]){date.setMinutes(d[8])}if(d[10]){date.setSeconds(d[10])}if(d[12]){date.setMilliseconds(Number("0."+d[12])*1000)}if(d[14]){offset=(Number(d[16])*60)+Number(d[17]);offset*=(_ref=d[15]==="-")!=null?_ref:{1:-1}}offset-=date.getTimezoneOffset();time=Number(date)+(offset*60*1000);date.setTime(Number(time));return date};Annotator.Plugin.Auth=(function(){__extends(Auth,Annotator.Plugin);Auth.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:true};function Auth(element,options){this.haveValidToken=__bind(this.haveValidToken,this);Auth.__super__.constructor.apply(this,arguments);this.element.data("annotator:auth",this);this.waitingForToken=[];if(this.options.token){this.setToken(this.options.token)}else{this.requestToken()}}Auth.prototype.requestToken=function(){this.requestInProgress=true;return $.getJSON(this.options.tokenUrl,__bind(function(data,status,xhr){if(status!=="success"){return console.error("Couldn't get auth token: "+status,xhr)}else{this.setToken(data);return this.requestInProgress=false}},this))};Auth.prototype.setToken=function(token){var _results;this.token=token;if(this.haveValidToken()){if(this.options.autoFetch){this.refreshTimeout=setTimeout((__bind(function(){return this.requestToken()},this)),(this.timeToExpiry()-2)*1000)}this.updateHeaders();_results=[];while(this.waitingForToken.length>0){_results.push(this.waitingForToken.pop().apply())}return _results}else{console.warn("Didn't get a valid token.");if(this.options.autoFetch){console.warn("Getting a new token in 10s.");return setTimeout((__bind(function(){return this.requestToken()},this)),10*1000)}}};Auth.prototype.haveValidToken=function(){var allFields;allFields=this.token&&this.token.authToken&&this.token.authTokenIssueTime&&this.token.authTokenTTL&&this.token.accountId&&this.token.userId;return allFields&&this.timeToExpiry()>0};Auth.prototype.timeToExpiry=function(){var expiry,issue,now,timeToExpiry;now=new Date().getTime()/1000;issue=createDateFromISO8601(this.token.authTokenIssueTime).getTime()/1000;expiry=issue+this.token.authTokenTTL;timeToExpiry=expiry-now;if(timeToExpiry>0){return timeToExpiry}else{return 0}};Auth.prototype.updateHeaders=function(){var current;current=this.element.data("annotator:headers");return this.element.data("annotator:headers",$.extend(current,{"x-annotator-auth-token":this.token.authToken,"x-annotator-auth-token-issue-time":this.token.authTokenIssueTime,"x-annotator-auth-token-ttl":this.token.authTokenTTL,"x-annotator-account-id":this.token.accountId,"x-annotator-user-id":this.token.userId}))};Auth.prototype.withToken=function(callback){if(!(callback!=null)){return}if(this.haveValidToken()){return callback()}else{this.waitingForToken.push(callback);if(!this.requestInProgress){return this.requestToken()}}};return Auth})();Annotator.Plugin.Store=(function(){__extends(Store,Annotator.Plugin);Store.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"};Store.prototype.options={prefix:"/store",autoFetch:true,annotationData:{},loadFromSearch:false,urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}};function Store(element,options){this._onError=__bind(this._onError,this);this._onBeforeSend=__bind(this._onBeforeSend,this);this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this);this._onLoadAnnotations=__bind(this._onLoadAnnotations,this);this._getAnnotations=__bind(this._getAnnotations,this);Store.__super__.constructor.apply(this,arguments);this.annotations=[]}Store.prototype.pluginInit=function(){var auth;if(!Annotator.supported()){return}auth=this.element.data("annotator:auth");if(auth){return auth.withToken(this._getAnnotations)}else{return this._getAnnotations()}};Store.prototype._getAnnotations=function(){if(this.options.loadFromSearch){return this.loadAnnotationsFromSearch(this.options.loadFromSearch)}else{return this.loadAnnotations()}};Store.prototype.annotationCreated=function(annotation){if(__indexOf.call(this.annotations,annotation)<0){this.registerAnnotation(annotation);return this._apiRequest("create",annotation,__bind(function(data){if(!(data.id!=null)){console.warn("Warning: No ID returned from server for annotation ",annotation)}return this.updateAnnotation(annotation,data)},this))}else{return this.updateAnnotation(annotation,{})}};Store.prototype.annotationUpdated=function(annotation){if(__indexOf.call(this.annotations,annotation)>=0){return this._apiRequest("update",annotation,(__bind(function(){return this.updateAnnotation(annotation)},this)))}};Store.prototype.annotationDeleted=function(annotation){if(__indexOf.call(this.annotations,annotation)>=0){return this._apiRequest("destroy",annotation,(__bind(function(){return this.unregisterAnnotation(annotation)},this)))}};Store.prototype.registerAnnotation=function(annotation){return this.annotations.push(annotation)};Store.prototype.unregisterAnnotation=function(annotation){return this.annotations.splice(this.annotations.indexOf(annotation),1)};Store.prototype.updateAnnotation=function(annotation,data){if(__indexOf.call(this.annotations,annotation)<0){console.error("Trying to update unregistered annotation!")}else{$.extend(annotation,data)}return $(annotation.highlights).data("annotation",annotation)};Store.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)};Store.prototype._onLoadAnnotations=function(data){if(data==null){data=[]}this.annotations=data;return this.annotator.loadAnnotations(data.slice())};Store.prototype.loadAnnotationsFromSearch=function(searchOptions){return this._apiRequest("search",searchOptions,this._onLoadAnnotationsFromSearch)};Store.prototype._onLoadAnnotationsFromSearch=function(data){if(data==null){data={}}return this._onLoadAnnotations(data.rows||[])};Store.prototype.dumpAnnotations=function(){var ann,_i,_len,_ref,_results;_ref=this.annotations;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){ann=_ref[_i];_results.push(JSON.parse(this._dataFor(ann)))}return _results};Store.prototype._apiRequest=function(action,obj,onSuccess){var id,options,request,url;id=obj&&obj.id;url=this._urlFor(action,id);options=this._apiRequestOptions(action,obj,onSuccess);request=$.ajax(url,options);request._id=id;request._action=action;return request};Store.prototype._apiRequestOptions=function(action,obj,onSuccess){var opts;opts={type:this._methodFor(action),beforeSend:this._onBeforeSend,dataType:"json",success:onSuccess||function(){},error:this._onError};if(action==="search"){opts=$.extend(opts,{data:obj})}else{opts=$.extend(opts,{data:obj&&this._dataFor(obj),contentType:"application/json; charset=utf-8"})}return opts};Store.prototype._urlFor=function(action,id){var replaceWith,url;replaceWith=id!=null?"/"+id:"";url=this.options.prefix||"/";url+=this.options.urls[action];url=url.replace(/\/:id/,replaceWith);return url};Store.prototype._methodFor=function(action){var table;table={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"};return table[action]};Store.prototype._dataFor=function(annotation){var data,highlights;highlights=annotation.highlights;delete annotation.highlights;$.extend(annotation,this.options.annotationData);data=JSON.stringify(annotation);if(highlights){annotation.highlights=highlights}return data};Store.prototype._onBeforeSend=function(xhr){var headers,key,val,_results;headers=this.element.data("annotator:headers");if(headers){_results=[];for(key in headers){val=headers[key];_results.push(xhr.setRequestHeader(key,val))}return _results}};Store.prototype._onError=function(xhr){var action,message;action=xhr._action;message="Sorry we could not "+action+" this annotation";if(xhr._action==="search"){message="Sorry we could not search the store for annotations"}else{if(xhr._action==="read"&&!xhr._id){message="Sorry we could not "+action+" the annotations from the store"}}switch(xhr.status){case 401:message="Sorry you are not allowed to "+action+" this annotation";break;case 404:message="Sorry we could not connect to the annotations store";break;case 500:message="Sorry something went wrong with the annotation store"}Annotator.showNotification(message,Annotator.Notification.ERROR);return console.error("API request failed: '"+xhr.status+"'")};return Store})();Annotator.Plugin.Filter=(function(){__extends(Filter,Annotator.Plugin);Filter.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"};Filter.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}};Filter.prototype.html={element:'<div class="annotator-filter">\n  <strong>Navigate:</strong>\n  <span class="annotator-filter-navigation">\n    <button class="annotator-filter-previous">Previous</button>\n    <button class="annotator-filter-next">Next</button>\n  </span>\n  <strong>Filter by:</strong>\n</div>',filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">Clear</button>\n</span>'};Filter.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:true,isFiltered:function(input,property){var keyword,_i,_len,_ref;if(!(input&&property)){return false}_ref=input.split(/\s*/);for(_i=0,_len=_ref.length;_i<_len;_i++){keyword=_ref[_i];if(property.indexOf(keyword)===-1){return false}}return true}};function Filter(element,options){this._onPreviousClick=__bind(this._onPreviousClick,this);this._onNextClick=__bind(this._onNextClick,this);this._onFilterKeyup=__bind(this._onFilterKeyup,this);this._onFilterBlur=__bind(this._onFilterBlur,this);this._onFilterFocus=__bind(this._onFilterFocus,this);this.updateHighlights=__bind(this.updateHighlights,this);element=$(this.html.element).appendTo(this.options.appendTo);Filter.__super__.constructor.call(this,element,options);this.filter=$(this.html.filter);this.filters=[];this.current=0}Filter.prototype.pluginInit=function(){var filter,_i,_len,_ref;_ref=this.options.filters;for(_i=0,_len=_ref.length;_i<_len;_i++){filter=_ref[_i];this.addFilter(filter)}this.updateHighlights();this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===true){return this.addFilter({label:"Annotation",property:"text"})}};Filter.prototype._insertSpacer=function(){var body,currentMargin;body=$("body");currentMargin=parseInt(body.css("margin-top"),10)||0;body.css("margin-top",currentMargin+this.element.outerHeight());return this};Filter.prototype._setupListeners=function(){var event,events,_i,_len;events=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(_i=0,_len=events.length;_i<_len;_i++){event=events[_i];this.annotator.subscribe(event,this.updateHighlights)}return this};Filter.prototype.addFilter=function(options){var filter;filter=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},options);filter.id="annotator-filter-"+filter.property;filter.annotations=[];filter.element=this.filter.clone().appendTo(this.element);filter.element.find("label").html(filter.label).attr("for",filter.id);filter.element.find("input").attr({id:filter.id,placeholder:"Filter by "+filter.label+"\u2026"});filter.element.find("button").hide();filter.element.data("filter",filter);this.filters.push(filter);return this};Filter.prototype.updateFilter=function(filter){var annotation,annotations,input,property,_i,_len,_ref;filter.annotations=[];this.updateHighlights();this.resetHighlights();input=$.trim(filter.element.find("input").val());if(input){annotations=this.highlights.map(function(){return $(this).data("annotation")});_ref=$.makeArray(annotations);for(_i=0,_len=_ref.length;_i<_len;_i++){annotation=_ref[_i];property=annotation[filter.property];if(filter.isFiltered(input,property)){filter.annotations.push(annotation)}}return this.filterHighlights()}};Filter.prototype.updateHighlights=function(){this.highlights=this.annotator.element.find(".annotator-hl:visible");return this.filtered=this.highlights.not(this.classes.hl.hide)};Filter.prototype.filterHighlights=function(){var activeFilters,annotation,annotations,filtered,highlights,index,uniques,_len,_ref;activeFilters=$.grep(this.filters,function(filter){return !!filter.annotations.length});filtered=((_ref=activeFilters[0])!=null?_ref.annotations:void 0)||[];if(activeFilters.length>1){annotations=[];$.each(activeFilters,function(){return $.merge(annotations,this.annotations)});uniques=[];filtered=[];$.each(annotations,function(){if($.inArray(this,uniques)===-1){return uniques.push(this)}else{return filtered.push(this)}})}highlights=this.highlights;for(index=0,_len=filtered.length;index<_len;index++){annotation=filtered[index];highlights=highlights.not(annotation.highlights)}highlights.addClass(this.classes.hl.hide);this.filtered=this.highlights.not(this.classes.hl.hide);return this};Filter.prototype.resetHighlights=function(){this.highlights.removeClass(this.classes.hl.hide);this.filtered=this.highlights;return this};Filter.prototype._onFilterFocus=function(event){var input;input=$(event.target);input.parent().addClass(this.classes.active);return input.next("button").show()};Filter.prototype._onFilterBlur=function(event){var input;if(!event.target.value){input=$(event.target);input.parent().removeClass(this.classes.active);return input.next("button").hide()}};Filter.prototype._onFilterKeyup=function(event){var filter;filter=$(event.target).parent().data("filter");if(filter){return this.updateFilter(filter)}};Filter.prototype._onNextClick=function(event){var active,annotation,current,index,next;active=this.highlights.not("."+this.classes.hl.hide);current=active.filter("."+this.classes.hl.active);if(!current.length){current=active.eq(-1)}annotation=current.data("annotation");index=active.index(current[0]);next=active.filter(":gt("+index+")").not(annotation.highlights).eq(0);if(!next.length){next=active.eq(0)}return this._scrollToHighlight(next.data("annotation").highlights)};Filter.prototype._onPreviousClick=function(event){var active,annotation,current,index,prev;active=this.highlights.not("."+this.classes.hl.hide);current=active.filter("."+this.classes.hl.active);if(!current.length){current=active.eq(0)}annotation=current.data("annotation");index=active.index(current[0]);prev=active.filter(":lt("+index+")").not(annotation.highlights).eq(-1);if(!prev.length){prev=active.eq(-1)}return this._scrollToHighlight(prev.data("annotation").highlights)};Filter.prototype._scrollToHighlight=function(highlight){highlight=$(highlight);this.highlights.removeClass(this.classes.hl.active);highlight.addClass(this.classes.hl.active);return $("html, body").animate({scrollTop:highlight.offset().top-(this.element.height()+20)},150)};Filter.prototype._onClearClick=function(event){return $(event.target).prev("input").val("").keyup().blur()};return Filter})();Annotator.Plugin.Markdown=(function(){__extends(Markdown,Annotator.Plugin);Markdown.prototype.events={annotationViewerTextField:"updateTextField"};function Markdown(element,options){this.updateTextField=__bind(this.updateTextField,this);if((typeof Showdown!="undefined"&&Showdown!==null?Showdown.converter:void 0)!=null){Markdown.__super__.constructor.apply(this,arguments);this.converter=new Showdown.converter()}else{console.error("To use the Markdown plugin, you must include Showdown into the page first.")}}Markdown.prototype.updateTextField=function(field,annotation){var text;text=Annotator.$.escape(annotation.text||"");return $(field).html(this.convert(text))};Markdown.prototype.convert=function(text){return this.converter.makeHtml(text)};return Markdown})();Annotator.Plugin.Unsupported=(function(){function Unsupported(){Unsupported.__super__.constructor.apply(this,arguments)}__extends(Unsupported,Annotator.Plugin);Unsupported.prototype.options={message:"Sorry your current browser does not support the Annotator"};Unsupported.prototype.pluginInit=function(){if(!Annotator.supported()){return $(__bind(function(){Annotator.showNotification(this.options.message);if((window.XMLHttpRequest===void 0)&&(ActiveXObject!==void 0)){return $("html").addClass("ie6")}},this))}};return Unsupported})();Annotator.Plugin.Permissions=(function(){__extends(Permissions,Annotator.Plugin);Permissions.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"};Permissions.prototype.options={showViewPermissionsCheckbox:true,showEditPermissionsCheckbox:true,userId:function(user){return user},userString:function(user){return user},userAuthorize:function(user,token){return this.userId(user)===token},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}};function Permissions(element,options){this.updateViewer=__bind(this.updateViewer,this);this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this);this.updatePermissionsField=__bind(this.updatePermissionsField,this);this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this);Permissions.__super__.constructor.apply(this,arguments);if(this.options.user){this.setUser(this.options.user);delete this.options.user}}Permissions.prototype.pluginInit=function(){var createCallback,self;if(!Annotator.supported()){return}self=this;createCallback=function(method,type){return function(field,annotation){return self[method].call(self,type,field,annotation)}};if(this.options.showViewPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>view</strong> this annotation",load:createCallback("updatePermissionsField","read"),submit:createCallback("updateAnnotationPermissions","read")})}if(this.options.showEditPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>edit</strong> this annotation",load:createCallback("updatePermissionsField","update"),submit:createCallback("updateAnnotationPermissions","update")})}this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){return this.annotator.plugins.Filter.addFilter({label:"User",property:"user",isFiltered:__bind(function(input,user){var keyword,_i,_len,_ref;user=this.options.userString(user);if(!(input&&user)){return false}_ref=input.split(/\s*/);for(_i=0,_len=_ref.length;_i<_len;_i++){keyword=_ref[_i];if(user.indexOf(keyword)===-1){return false}}return true},this)})}};Permissions.prototype.setUser=function(user){return this.user=user};Permissions.prototype.addFieldsToAnnotation=function(annotation){if(annotation){annotation.permissions=this.options.permissions;if(this.user){return annotation.user=this.user}}};Permissions.prototype.authorize=function(action,annotation,user){var token,tokens,_i,_len;if(user===void 0){user=this.user}if(annotation.permissions){tokens=annotation.permissions[action]||[];if(tokens.length===0){return true}for(_i=0,_len=tokens.length;_i<_len;_i++){token=tokens[_i];if(this.options.userAuthorize.call(this.options,user,token)){return true}}return false}else{if(annotation.user){return user&&this.options.userId(user)===annotation.user}}return true};Permissions.prototype.updatePermissionsField=function(action,field,annotation){var dummy,input;field=$(field).show();input=field.find("input").removeAttr("disabled");if(!this.authorize("admin",annotation)){field.hide()}if(this.authorize(action,annotation||{},null)){input.attr("checked","checked");dummy={permissions:this.options.permissions};if(this.authorize(action,dummy,null)){return input.attr("disabled","disabled")}}else{return input.removeAttr("checked")}};Permissions.prototype.updateAnnotationPermissions=function(type,field,annotation){var dataKey,permissions;if(!annotation.permissions){annotation.permissions=this.options.permissions}dataKey=type+"-permissions";if($(field).find("input").is(":checked")){$.data(annotation,dataKey,annotation.permissions[type]);return annotation.permissions[type]=[]}else{permissions=$.data(annotation,dataKey);if(permissions){return annotation.permissions[type]=permissions}}};Permissions.prototype.updateViewer=function(field,annotation,controls){var user,username;field=$(field);username=this.options.userString(annotation.user);if(annotation.user&&username&&typeof username==="string"){user=Annotator.$.escape(this.options.userString(annotation.user));field.html(user).addClass("annotator-user")}else{field.remove()}if(annotation.permissions){if(!this.authorize("update",annotation)){controls.hideEdit()}if(!this.authorize("delete",annotation)){return controls.hideDelete()}}else{if(annotation.user&&!this.authorize(null,annotation)){controls.hideEdit();return controls.hideDelete()}}};return Permissions})()}).call(this);